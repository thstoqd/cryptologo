# 排行榜更新问题排查指南

## 🔍 问题诊断结果

根据诊断脚本，发现以下问题：

1. **最后更新时间**: `2024-01-15T10:30:00Z`（717 天前）
   - ⚠️ 数据超过 1 天未更新，说明自动更新没有生效

2. **Workflow 配置**: ✅ 已正确配置
   - 定时任务: 每天 UTC 00:00（北京时间 08:00）
   - 权限配置: ✅ 已添加 `contents: write` 权限
   - API Key 引用: ✅ 已配置

## 🔧 已修复的问题

### 1. 添加了权限配置
```yaml
permissions:
  contents: write
```
这确保 GitHub Actions 有权限提交更改到仓库。

### 2. 改进了提交逻辑
- 添加了错误处理（`|| exit 0`）
- 使用 `git push origin HEAD:${{ github.ref }}` 确保推送到正确的分支

### 3. 添加了更详细的日志
- 在检查更改步骤中添加了 `git status` 输出
- 更清晰的错误提示

## 📋 需要检查的事项

### ✅ 1. GitHub Secrets 配置（最重要）

**检查步骤：**
1. 访问你的 GitHub 仓库
2. 进入 **Settings** → **Secrets and variables** → **Actions**
3. 确认是否存在 `COINMARKETCAP_API_KEY`
4. 如果不存在，点击 **New repository secret** 添加：
   - **Name**: `COINMARKETCAP_API_KEY`
   - **Value**: 你的 CoinMarketCap API Key

**获取 API Key：**
1. 访问 https://coinmarketcap.com/api/
2. 注册账号并获取免费 API Key（Basic 版即可）

### ✅ 2. GitHub Actions 运行状态

**检查步骤：**
1. 访问 `https://github.com/YOUR_USERNAME/YOUR_REPO/actions`
2. 查看左侧的 **"更新代币排名"** workflow
3. 检查运行历史：
   - 是否有运行记录？
   - 最近一次运行是什么时候？
   - 运行状态是成功还是失败？

**如果从未运行过：**
- 点击 workflow 名称
- 点击右上角的 **"Run workflow"** 手动触发一次
- 查看运行日志，确认是否有错误

### ✅ 3. 分支保护规则

**如果主分支（main/master）受保护：**

1. 进入 **Settings** → **Branches**
2. 找到分支保护规则
3. 在 **"Allow specified actors to bypass required pull requests"** 中：
   - 添加 `GitHub Actions` 或
   - 添加你的 GitHub 用户名

或者：

1. 在分支保护规则中
2. 找到 **"Restrict who can push to matching branches"**
3. 确保 GitHub Actions 有权限

### ✅ 4. 手动测试脚本

**在本地测试更新脚本：**

```bash
# 设置 API Key（PowerShell）
$env:COINMARKETCAP_API_KEY="你的API_KEY"

# 运行更新脚本
node scripts/update-ranks.js
```

**如果脚本运行成功：**
- 检查 `data/icons-metadata.json` 中的 `lastUpdated` 是否更新
- 检查代币的 `rank` 字段是否更新

**如果脚本运行失败：**
- 查看错误信息
- 检查 API Key 是否正确
- 检查网络连接

## 🚀 快速修复步骤

### 步骤 1: 配置 GitHub Secrets
```
Settings → Secrets and variables → Actions → New repository secret
Name: COINMARKETCAP_API_KEY
Value: [你的 API Key]
```

### 步骤 2: 手动触发一次测试
```
Actions → 更新代币排名 → Run workflow → Run workflow
```

### 步骤 3: 检查运行日志
- 查看是否有错误
- 确认是否成功提交更改

### 步骤 4: 验证更新
- 检查 `data/icons-metadata.json` 中的 `lastUpdated` 字段
- 检查代币排名是否更新

## 📊 验证更新是否成功

运行诊断脚本：
```bash
node scripts/check-update-status.js
```

**成功标志：**
- `lastUpdated` 显示为今天或昨天的日期
- 代币排名与 CoinMarketCap 一致
- GitHub Actions 显示成功运行

## 🔄 自动更新时间

- **默认时间**: 每天 UTC 00:00（北京时间 08:00）
- **更新频率**: 每日 1 次
- **触发部署**: 自动提交后，Cloudflare Pages 会自动重新部署

## ⚠️ 常见问题

### 问题 1: "API 请求失败"
**原因**: API Key 无效或已过期
**解决**: 重新获取并更新 GitHub Secrets 中的 API Key

### 问题 2: "没有排名更新，跳过提交"
**原因**: 所有代币排名都没有变化
**解决**: 这是正常的，说明排名没有变化

### 问题 3: "Permission denied"
**原因**: GitHub Actions 没有写入权限
**解决**: 检查分支保护规则，确保允许 workflow 提交

### 问题 4: Workflow 从未运行
**原因**: 
- 定时任务可能还没到时间
- 仓库可能没有启用 GitHub Actions
**解决**: 
- 手动触发一次测试
- 检查仓库设置中的 Actions 权限

## 📞 需要帮助？

如果按照以上步骤仍然无法解决问题，请检查：

1. GitHub Actions 的运行日志（最详细的错误信息）
2. CoinMarketCap API 的使用情况（是否超出限制）
3. 仓库的 Actions 权限设置

